version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.5

jobs:


  install_stage:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install Python Dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt

      - run:
          name: Install OS dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y jq unzip wget

      - run:
          name: Install Java 17 (Amazon Corretto)
          command: |
            sudo apt-get purge -y openjdk*
            sudo apt-get install -y java-common
            wget https://corretto.aws/downloads/latest/amazon-corretto-17-x64-linux-jdk.deb
            sudo dpkg -i amazon-corretto-17-x64-linux-jdk.deb
            java --version


  pylint_stage:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install Python Tools
          command: |
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install pylint

      - run:
          name: Run pylint
          command: |
            pylint easy_bill || true

  sonar_stage:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install Sonar Scanner
          command: |
            wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip sonar-scanner-cli-5.0.1.3006-linux.zip
            mv sonar-scanner-5.0.1.3006-linux sonar-scanner

      - run:
          name: Run Sonar Scan
          command: |
            sonar-scanner/bin/sonar-scanner \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.projectKey=$SONAR_PROJECT_KEY \
              -Dsonar.organization=$SONAR_ORG \
              -Dsonar.exclusions=**/.c9/**,**/node_modules/**,**/venv/** \
              -Dsonar.text.exclusions=**/.c9/** \
              -Dsonar.scm.disabled=true \
              -Dsonar.scm.exclusions.enabled=true \
              || true



  django_test_stage:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install Python Dependencies
          command: |
            pip install --upgrade pip
            pip install -r requirements.txt

      - run:
          name: Django Tests
          command: |
            python manage.py test


  build_and_deploy:
    docker:
      - image: cimg/python:3.11

    environment:
      AWS_REGION: us-east-1

    steps:
      - checkout

      - run:
          name: Create Deployment ZIP
          command: |
            zip -r deploy.zip . -x "*.git*"

      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_REGION

      - run:
          name: Load AWS Session Token
          command: |
            echo "export AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Deploy to Elastic Beanstalk
          command: |
            pip install awsebcli
            eb init "devops-eb-myapp" --platform python-3.11 --region "$AWS_REGION"
            eb deploy myapp-x23304723


# ==========================================================
# WORKFLOW
# ==========================================================
workflows:
  version: 2
  full_ci_pipeline:
    jobs:
      - install_stage
      - pylint_stage:
          requires:
            - install_stage
      - sonar_stage:
          requires:
            - install_stage
      - django_test_stage:
          requires:
            - pylint_stage
      - build_and_deploy:
          requires:
            - django_test_stage
            - sonar_stage
